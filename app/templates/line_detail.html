<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<title>Línea {{ line.short_name }} ({{ line.line_id }}) · {{ repo.nucleus_name(line.nucleus_id) or nucleus.name }}</title>
</head>
<body>
<p>
	<a href="/lines">&larr; Volver al listado</a>
</p>

<h1>Línea {{ line.short_name }} ({{ line.line_id }}) · {{ repo.nucleus_name(line.nucleus_id) or nucleus.name }}</h1>

{% if not line.variants %}
	<p>Esta línea no tiene variantes detectadas.</p>
{% else %}
	<h2>Variantes</h2>
	<table border="1" cellpadding="6" cellspacing="0">
		<thead>
		<tr>
			<th>Canónica</th>
			<th>Terminales (A ↔ B)</th>
			<th>Dirección</th>
			<th>Rutas (route_id)</th>
			<th>Acciones</th>
		</tr>
		</thead>
		<tbody>
		{% for var in line.variants %}
			{% set a = var.terminals_sorted[0] %}
			{% set b = var.terminals_sorted[1] %}
			{% set canon_mark = "✔" if var.is_canonical else "—" %}
			{% set dir_keys = var.directions.keys()|list|sort %}
			{% if dir_keys|length == 0 %}
				<tr>
					<td style="text-align:center">{{ canon_mark }}</td>
					<td>
						{% if a %}<a href="/stations/{{ nucleus.slug or line.nucleus_id }}/{{ a }}">{{ repo.get_stop_name_or_id(a) }}</a>{% else %}—{% endif %}
						&nbsp;↔&nbsp;
						{% if b %}<a href="/stations/{{ nucleus.slug or line.nucleus_id }}/{{ b }}">{{ repo.get_stop_name_or_id(b) }}</a>{% else %}—{% endif %}
					</td>
					<td>—</td>
					<td>
						{% for rid in var.route_ids %}
							<div><a href="/routes/{{ nucleus.slug or line.nucleus_id }}/{{ rid }}">{{ rid }}</a></div>
						{% endfor %}
					</td>
					<td>—</td>
				</tr>
			{% else %}
				{% for did in dir_keys %}
					{% set d = var.directions[did] %}
					<tr>
						{% if loop.first %}
							<td style="text-align:center" rowspan="{{ dir_keys|length }}">{{ canon_mark }}</td>
							<td rowspan="{{ dir_keys|length }}">
								{% if a %}<a href="/stations/{{ nucleus.slug or line.nucleus_id }}/{{ a }}">{{ repo.get_stop_name_or_id(a) }}</a>{% else %}—{% endif %}
								&nbsp;↔&nbsp;
								{% if b %}<a href="/stations/{{ nucleus.slug or line.nucleus_id }}/{{ b }}">{{ repo.get_stop_name_or_id(b) }}</a>{% else %}—{% endif %}
							</td>
						{% endif %}
						<td><strong>{{ did }}</strong></td>
						<td>
							{% if d.route_ids %}
								<div>
									{% for rid in d.route_ids %}
										<div><a href="/routes/{{ nucleus.slug or line.nucleus_id }}/{{ rid }}">{{ rid }}</a></div>
									{% endfor %}
								</div>
							{% else %}
								—
							{% endif %}
						</td>
						<td>
							{% if d.route_ids and d.route_ids|length %}
								<a href="/routes/{{ nucleus.slug or line.nucleus_id }}/{{ d.route_ids[0] }}/stops">Ver paradas</a>
							{% else %}
								—
							{% endif %}
						</td>
					</tr>
				{% endfor %}
			{% endif %}
		{% endfor %}
		</tbody>
	</table>
	
	<p style="margin-top:1rem">
		<em>Nota:</em> una <strong>variante</strong> agrupa rutas que comparten los mismos terminales
		(ignorando el sentido). La variante <strong>canónica</strong> es la que más estaciones cubre.
	</p>
{% endif %}
</body>
</html>
