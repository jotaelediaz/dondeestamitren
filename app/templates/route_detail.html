{%- extends "base-layout.html" %}
{%- from "partials/helper_macros.html" import get_cercanias_line_icon, print_station_route_map with context %}
{%- block app_content %}
	<section id="line-route" class="line-route app-main-content" aria-label="Ruta de la línea {{ route.route_long_name if route else '' }}">
		<div class="grouped-lists-scroll">
			<div class="app-block-padding sticky-title">
				<div class="line-chip-header">
					<div class="line-chip-icon chip-icon-group">
						<div class="line-chip-icon cercanias-logo-icon">
							<img alt="Cercanías" src="/static/img/icon-cercanias.svg" />
						</div>
						{{ get_cercanias_line_icon(route.route_short_name, route.nucleus_id, route.color_bg) }}
					</div>
					<h2 class="line-name">
						{% set origin_name, destination_name = route.terminals_names %} {{ destination_name }}
					</h2>
					<div class="line-chip-header-buttons">
						{#<button type="button" class="line-chip-header-button header-secondary-button toggle-connections-shown" title="Mostrar/Ocultar correspondencias" aria-pressed="true">
							<i class="material-symbols-rounded" aria-hidden="true" style="font-size:1.2rem;line-height:1;">transfer_within_a_station</i>
						</button>#}
						{% set reverse_id = repo.get_opposite_route_id(route.route_id) %}
						{% if reverse_id %}
							<a class="line-chip-header-button line-toggle-button line-toggle-reverse" href="/routes/{{ nucleus.slug }}/{{ reverse_id }}" title="Ver sentido inverso" aria-label="Ver sentido inverso" rel="alternate">
								<i class="material-symbols-rounded" aria-hidden="true" style="font-size:1.2rem;line-height:1;">swap_vert</i>
							</a>
						{% endif %}
					</div>
				</div>
			</div>
			
			<div class="app-block-padding app-block-vertical-padding">
				<ul class="grid-route-map" data-number-of-stations="{{ route.stations|length }}" style="--number-of-stations: {{ route.stations|length }}; --line-color: {{ route.color_bg }};">
					{% for stop in route.stations %}
						<li class="grid-route-map-station {{ 'origin-station' if route.origin.stop_id == stop.stop_id else 'destination-station' if route.destination.stop_id == stop.stop_id else 'mid-station' }}"
						    data-station-id="{{ stop.station_id or stop.stop_id }}">
							{{ print_station_route_map(stop, route.route_short_name) }}
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</section>
	
	<div id="route-context"
	     data-nucleus="{{ nucleus.slug }}"
	     data-line-id="{{ route.line_id }}"
	     data-route-id="{{ route.route_id }}"
	     data-dir="{{ (route.direction_id or '0') | string }}">
	</div>
	
	{% if open_stop_id %}
		<script>
        (function() {
            const url = "/routes/{{ nucleus.slug }}/{{ route.route_id }}/stops/{{ open_stop_id }}";
            function tryOpenDrawer() {
                if (window.AppDrawers && window.AppDrawers.openStop) {
                    window.AppDrawers.openStop(url);
                    return true;
                }
                return false;
            }
            if (tryOpenDrawer()) return;

            document.addEventListener('DOMContentLoaded', function() {
                if (tryOpenDrawer()) return;
                requestAnimationFrame(() => {
                    if (tryOpenDrawer()) return;
                    setTimeout(tryOpenDrawer, 50);
                });
            });
        })();
		</script>
	{% endif %}
	
	{% if open_trains_panel %}
		<script>
        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('btn-toggle-trains')?.click();
        });
		</script>
	{% endif %}
{%- endblock %}


{% block action_buttons %}
	<div id="action-buttons-items" hx-swap-oob="true">
		<nav id="bottom-actions-nav" role="navigation" aria-label="Menú de ruta" class="navbar-buttons-group">
			<div class="nav-buttons-group-inner">
				<button id="btn-toggle-trains"
				        class="navbar-button"
				        type="button"
				        aria-controls="drawer"
				        aria-expanded="false"
				        title="Mostrar/ocultar trenes en la ruta"
				        data-url="/lines/{{ nucleus.slug }}/{{ route.line_id }}/trains?dir={{ '0' if (route.direction_id or '') in ('', '0') else '1' }}&source_rid={{ route.route_id }}">
					<i class="navbar-icon navbar-button-icon material-symbols-rounded">directions_railway</i>
				</button>
			</div>
		</nav>
	</div>
{% endblock %}


{%- block extra_stylesheets -%}
{#	<link rel="preload" href="{{ request.url_for('static', path='fonts/Via-Medium.woff2') }}" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="{{ request.url_for('static', path='fonts/Via-Bold.woff2') }}" as="font" type="font/woff2" crossorigin>
	<link rel="stylesheet" href="/static/css/mitren-renfe-style.css">#}
{%- endblock -%}