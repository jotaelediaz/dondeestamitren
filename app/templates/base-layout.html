<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-title" content="Mi Tren">
	<meta name="description" content="{% block meta_description %}Consulta en tiempo real la ubicación de trenes de Cercanías en toda España. Horarios, retrasos y seguimiento de tu tren.{% endblock %}">
	<meta name="keywords" content="cercanías, trenes, tiempo real, horarios, retrasos, renfe, gtfs, madrid, seguimiento, ubicación, rodalies">
	<meta name="author" content="dondeestamitren">
	<meta name="robots" content="index, follow">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="¿Dónde Está Mi Tren?">
	<meta property="og:title" content="{% block og_title %}{{ self.title() }}{% endblock %}">
	<meta property="og:description" content="{% block og_description %}{{ self.meta_description() }}{% endblock %}">
	<meta property="og:locale" content="es_ES">
	<link href="{{ request.url_for('static', path='img/favicon.svg') }}" rel="shortcut icon">
	<link href="{{ request.url_for('static', path='img/favicon.png') }}" rel="shortcut icon">
	<link rel="apple-touch-icon" sizes="144x144" href="{{ request.url_for('static', path='img/favicon_apple.png') }}">
	<title hx-head="re-eval">{% block title %}Dónde Está Mi Tren{% endblock %}</title>
	
	<link rel="preload" href="{{ request.url_for('static', path='fonts/Sora-VariableFont_wght.woff2') }}" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="{{ request.url_for('static', path='fonts/Rubik-VariableFont_wght.woff2') }}" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="{{ request.url_for('static', path='fonts/MaterialSymbolsRoundedVF.woff2') }}" as="font" type="font/woff2" crossorigin>
	
	<link rel="stylesheet" href="{{ request.url_for('static', path='css/mitren-common-style.css') }}">
	<link rel="stylesheet" href="{{ request.url_for('static', path='vendor/maplibre-gl.css') }}">
	{% block extra_stylesheets %}{% endblock %}
</head>
<body
	hx-ext="view-transitions"
	hx-boost="true"
	hx-target="#content"
	hx-select="#content > *"
	hx-select-oob="#bottom-nav-items, #topbar-items, #action-buttons-items"
	hx-push-url="true"
	data-nucleus="{{ nucleus.slug if nucleus else '' }}">

<script src="{{ request.url_for('static', path='vendor/htmx.min.js') }}"></script>

<main id="app" class="tft-screen-size container-main">
	<header id="topbar">
		{% block topbar %}{% include "partials/topbar.html" %}{% endblock %}
	</header>
	
	<input type="hidden" id="state-nuc"   name="nucleus"  value="{{ nucleus.slug if nucleus else '' }}">
	<input type="hidden" id="state-route" name="route_id" value="{{ route_id if route_id is defined else '' }}">
	<input type="hidden" id="state-dir"   name="dir"      value="{{ dir if dir is defined else '' }}">
	
	<section id="content" hx-history-elt hx-swap="morph:innerHTML transition:true settle:150ms">
		{% block app_content %}{% endblock %}
	</section>
	
	<aside id="drawer" class="drawer-bottom" hidden aria-hidden="true" hx-preserve>
		<div id="drawer-content" class="drawer-inner"></div>
	</aside>
	
	<nav id="bottom-nav" role="navigation" aria-label="Menú">
		{% block bottom_navbar %}{% include "partials/navbar.html" %}{% endblock %}
	</nav>
</main>

<div id="action-buttons">
	<div id="action-buttons-items"></div>
</div>

{% block action_buttons %}{% endblock %}

{% block config_menu %}{% include "partials/config_menu.html" %}{% endblock %}

<script defer src="{{ request.url_for('static', path='vendor/maplibre-gl.js') }}" onload="document.dispatchEvent(new Event('MapLibreReady'))"></script>
<script defer src="{{ request.url_for('static', path='js/scripts.js') }}"></script>
<script defer src="{{ request.url_for('static', path='js/train-detail.js') }}"></script>
<script defer src="{{ request.url_for('static', path='js/nucleus.js') }}"></script>
<script defer src="{{ request.url_for('static', path='js/train-map.js') }}"></script>
{% block extra_scripts %}{% endblock %}

<script>
    htmx.config.globalViewTransitions = true;
    htmx.config.refreshOnHistoryMiss = true;
    htmx.config.historyCacheSize = 20;
    htmx.config.scrollIntoViewOnBoost = true;

    document.body.addEventListener('htmx:configRequest', (evt) => {
        const elt = evt.detail.elt;
        if (!elt) return;
		    
        if (elt.closest && elt.closest('#drawer')) {
            const has = (k) => Object.prototype.hasOwnProperty.call(evt.detail.parameters, k);
            const ctx = document.getElementById('route-context');
            if (!ctx) return;
            if (!has('dir'))        evt.detail.parameters.dir        = ctx.getAttribute('data-dir') || '';
            if (!has('source_rid')) evt.detail.parameters.source_rid = ctx.getAttribute('data-route-id') || '';
            if (!has('nucleus'))    evt.detail.parameters.nucleus    = ctx.getAttribute('data-nucleus') || '';
        }
    });

    document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.target && e.target.id === 'content') {
            const ctx = document.getElementById('route-context');
            if (!ctx) return;
            const byId = (id) => document.getElementById(id);
            const set  = (id, val) => { const el = byId(id); if (el) el.value = val ?? ''; };
            set('state-nuc',   ctx.dataset.nucleus);
            set('state-route', ctx.dataset.routeId);
            set('state-dir',   ctx.dataset.dir);
        }

        if (e.target && (e.target.id === 'content' || e.target.id === 'drawer-content')) {
            window.initDrawers && window.initDrawers();
        }
    });
</script>
</body>
</html>
