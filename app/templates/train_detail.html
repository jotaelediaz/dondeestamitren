{%- extends "base-layout.html" %}
{%- from "partials/helper_macros.html" import get_cercanias_line_icon, print_station_train_status_route_map with context %}

{%- block app_content %}
	{% set trip_stops = trip.stops if trip and trip.stops else [] %}
	{% set first_stop = trip_stops|first if trip_stops else None %}
	{% set last_stop = trip_stops|last if trip_stops else None %}
	{% set origin_time = (first_stop.eta_dep_hhmm if first_stop else None)
		or (first_stop.eta_arr_hhmm if first_stop else None)
		or (first_stop.sched_dep_hhmm if first_stop else None)
		or (first_stop.sched_arr_hhmm if first_stop else None)
		or train_service.scheduled_departure_hhmm %}
	{% set destination_time = (last_stop.eta_arr_hhmm if last_stop else None)
		or (last_stop.eta_dep_hhmm if last_stop else None)
		or (last_stop.sched_arr_hhmm if last_stop else None)
		or (last_stop.sched_dep_hhmm if last_stop else None) %}
	{% set base_status_text = train_service.status_text if train_service else None %}
	{% set train_status_label = base_status_text or ('Programado' if kind == 'scheduled' else 'Estado desconocido') %}
	{% set status_text_lower = (base_status_text or '')|lower %}
	{% set stop_scope = namespace(current=None, upcoming=None) %}
	{% for stop in trip_stops %}
		{% set normalized_status = (stop.status or stop.flag or '')|upper %}
		{% if stop_scope.current is none and normalized_status == 'CURRENT' %}
			{% set stop_scope.current = stop %}
		{% elif stop_scope.upcoming is none and normalized_status in ['NEXT', 'UPCOMING', 'FUTURE'] %}
			{% set stop_scope.upcoming = stop %}
		{% endif %}
	{% endfor %}
	{% if kind == 'live' %}
		{% if stop_scope.current %}
			{% set current_name = stop_scope.current.stop_name
				or repo.get_stop_name(stop_scope.current.stop_id)
				or stop_scope.current.stop_id %}
			{% set train_status_label = 'Parado en ' ~ current_name %}
		{% elif stop_scope.upcoming %}
			{% set next_name = stop_scope.upcoming.stop_name
				or repo.get_stop_name(stop_scope.upcoming.stop_id)
				or stop_scope.upcoming.stop_id %}
			{% set status_prefix = 'Llegando a' if ('llegando' in status_text_lower or 'incoming' in status_text_lower or 'arriving' in status_text_lower) else 'En camino a' %}
			{% set train_status_label = status_prefix ~ ' ' ~ next_name %}
		{% endif %}
	{% endif %}
	<section id="line-route" class="line-route app-main-content" aria-label="Tren {{ train_service.train_label }}" style="--train-color: {{ route.color_bg }}">
		<div class="app-block-padding sticky-title">
			<div class="line-chip-header">
				<div class="line-chip-icon chip-icon-group train-detail-header">
					<div class="line-chip-icon cercanias-logo-icon">
						<img alt="Cercanías" src="/static/img/icon-cercanias.svg" />
					</div>
					<div class="route-train-chip-icon chip-icon">
						<i class="material-symbols-rounded" aria-hidden="true">train</i>
					</div>
				</div>
				<h2 class="line-name">
					Tren {{ train_service.train_label }}
				</h2>
				<div class="line-chip-header-buttons">
				</div>
			</div>
		</div>
		
		<div class="app-block-padding app-block-vertical-padding">
			<div class="train-details-panel" data-train-id="{{ train_service.train_label }}" style="--line-color: {{ route.color_bg }}">
				<div class="train-details-header">
					<a href="/routes/{{ nucleus.slug }}/{{ train_service.route_id }}" class="train-details-route-link train-details-preheader">
						{{ get_cercanias_line_icon(train_service.route_short_name, nucleus.slug, red) }}
						<span class="train-details-label">Cercanías {{ nucleus.name }}</span>
					</a>
					<div class="train-details-header-content">
						<div class="train-header-terminal origin">
							{{ train_service.origin_name or '—' }}
						</div>
						<div class="train-header-terminal through" aria-hidden="true">
							<span class="through-chevrons">
								<span class="through-chevron"></span>
								<span class="through-chevron"></span>
								<span class="through-chevron"></span>
							</span>
						</div>
						<div class="train-header-terminal destination">
							{{ train_service.destination_name or '—' }}
						</div>
					</div>
				</div>
				<div class="train-details-content">
					<div class="mini-route-map-grid">
						<div class="grid-route-map-station origin-station">
							<div class="station-block origin-station">
								<div class="grid-route-line">
									<div class="route-line-time">
										<span class="arrival-hour">{{ origin_time or '--:--' }}</span>
									</div>
									<div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
										<i class="route-line-fragment" aria-hidden="true"></i>
										<i class="route-dot" aria-hidden="true"></i>
									</div>
								</div>
								
								<div class="grid-route-station-info">
									<div class="grid-route-station-name">
										<span class="station-label">Salida</span>
									</div>
								</div>
							</div>
						</div>
						<div class="grid-route-map-station through-station">
							<div class="station-block origin-station">
								<div class="grid-route-line">
									<div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
										<i class="route-line-fragment" aria-hidden="true"></i>
										<i class="route-dot" aria-hidden="true"></i>
									</div>
								</div>
								
								<div class="grid-route-station-info">
									<div class="grid-route-station-name">
										<span class="station-label">{{ train_status_label }}</span>
									</div>
								</div>
							</div>
						</div>
						<div class="grid-route-map-station destination-station">
							<div class="station-block origin-station">
								<div class="grid-route-line">
									<div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
										<i class="route-line-fragment" aria-hidden="true"></i>
										<i class="route-dot" aria-hidden="true"></i>
									</div>
									<div class="route-line-time">
										<span class="arrival-hour">{{ destination_time or '--:--' }}</span>
									</div>
								</div>
								
								<div class="grid-route-station-info">
									<div class="grid-route-station-name">
										<span class="station-label">Llegada</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
{#				<li><strong>Vía:</strong> {{ train_service.platform or '—' }}</li>
				<li><strong>Posición:</strong>
					{% if train_service.lat is not none and train_service.lon is not none %}
						{{ '%.5f'|format(train_service.lat) }}, {{ '%.5f'|format(train_service.lon) }}
					{% else %}—{% endif %}
				</li>#}
			</div>
		</div>

		<div class="grouped-lists-scroll">
			<div class="app-block-padding app-block-vertical-padding">
				<ul class="grid-route-map train-status-route-map {{ 'scheduled-train' if kind == 'scheduled' else 'live-train' if kind == 'live'}}" data-number-of-stations="{{ trip.stops|length }}" style="--number-of-stations: {{ trip.stations|length }}; --line-color: {{ route.color_bg }};">
					{% for stop in trip.stops %}
						{% set scheduled_time = stop.scheduled_hhmm or stop.sched_arr_hhmm or stop.sched_dep_hhmm %}
						{% set rt_arrival_time = rt_arrival_times.get(stop.stop_id) if kind == 'live' else None %}
						
						{% set stop_status = stop.status or stop.flag or 'upcoming' %}
						{% set stop_status_class = 'current-station' if stop_status in ['CURRENT'] else
							'future-station'  if stop_status in ['FUTURE','NEXT','UPCOMING','upcoming'] else
							'passed-station'  if stop_status in ['PASSED'] else ''
						%}
						{% set station_position = 'origin-station' if (trip.stops|first).stop_id == stop.stop_id else 'destination-station' if (trip.stops|last).stop_id == stop.stop_id else 'mid-station' %}
						
						<li class="grid-route-map-station {{ stop_status_class }} {{ station_position }}" data-station-id="{{ stop.station_id or stop.stop_id }}">
							{{ print_station_train_status_route_map(stop, station_position, scheduled_time, rt_arrival_time, stop_status) }}
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</section>
{%- endblock %}

{% block action_buttons %}
	<div id="action-buttons-items" hx-swap-oob="true"></div>
{% endblock %}
