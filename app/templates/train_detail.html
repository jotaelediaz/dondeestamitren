{%- extends "base-layout.html" %}
{%- from "partials/helper_macros.html" import get_cercanias_line_icon, print_station_train_status_route_map with context %}

{%- block app_content %}
	<section id="line-route" class="line-route app-main-content" aria-label="Tren {{ train_service.train_label }}" style="--train-color: {{ route.color_bg }}">
		<div class="app-block-padding sticky-title">
			<div class="line-chip-header">
				<div class="line-chip-icon chip-icon-group train-detail-header">
					<div class="line-chip-icon cercanias-logo-icon">
						<img alt="Cercanías" src="/static/img/icon-cercanias.svg" />
					</div>
					<div class="route-train-chip-icon chip-icon">
						<i class="material-symbols-rounded" aria-hidden="true">train</i>
					</div>
					{#{{ get_cercanias_line_icon(route.route_short_name, route.nucleus_id, route.color_bg) }}#}
				</div>
				<h2 class="line-name">
					Tren {{ train_service.train_label }}
				</h2>
				<div class="line-chip-header-buttons">
				</div>
			</div>
		</div>
		
		<div class="app-block-padding app-block-vertical-padding">
			<div class="train-details-panel" data-train-id="{{ train_service.train_label }}">
				<li><strong>Estado:</strong> {{ train_service.status_text or '—' }}</li>
				<li><strong>Parada actual:</strong>
					{% if kind == 'live' and train %}
						{{ repo.get_stop_name(train.stop_id) }} <i>({{ train_service.stop_id or "—" }})</i>
					{% else %}—{% endif %}
				</li>
				<li><strong>Vía:</strong> {{ train_service.platform or '—' }}</li>
				<li><strong>Posición:</strong>
					{% if train_service.lat is not none and train_service.lon is not none %}
						{{ '%.5f'|format(train_service.lat) }}, {{ '%.5f'|format(train_service.lon) }}
					{% else %}—{% endif %}
				</li>
				<li><strong>Ruta:</strong>{{ train_service.route_id }}</li>
				<li><strong>Código de línea:</strong> {{ train_service.route_short_name or '—' }}</li>
			</div>
		</div>
		
		<div class="grouped-lists-scroll">
			<div class="app-block-padding app-block-vertical-padding">
				<ul class="grid-route-map train-status-route-map" data-number-of-stations="{{ trip.stops|length }}" style="--number-of-stations: {{ trip.stations|length }}; --line-color: {{ route.color_bg }};">
					{% for stop in trip.stops %}
						{% set scheduled_time = stop.scheduled_hhmm or stop.sched_arr_hhmm or stopsched_dep_hhmm %}
						{% set stop_status = stop.status or stop.flag or 'upcoming' %}
						<li class="grid-route-map-station {{ 'current-station' if stop_status in ['CURRENT'] else 'future-station' if stop_status in ['FUTURE'] else 'passed-station' if stop_status in ['PASSED']}} {{ 'origin-station' if (trip.stops|first).stop_id == stop.stop_id else 'destination-station' if (trip.stops|last).stop_id == stop.stop_id else 'mid-station' }}" data-station-id="{{ stop.station_id or stop.stop_id }}">
							{{ print_station_train_status_route_map(stop, scheduled_time) }}
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</section>
{%- endblock %}

{% block action_buttons %}
	<div id="action-buttons-items" hx-swap-oob="true"></div>
{% endblock %}



{#
{%- extends "base-layout.html" %}
{%- block app_content %}
	<header>
		{% if nucleus %}
			<a href="/trains/{{ nucleus.slug }}">&larr; Volver a {{ nucleus.name }}</a>
		{% else %}
			<a href="/trains/">&larr; Volver a trenes</a>
		{% endif %}
		<h1>Tren {{ train.train_id }}</h1>
		<p>Última actualización: {{ last_snapshot }}</p>
	</header>
	
	<table border="1" cellpadding="6" cellspacing="0">
		<thead>
		<tr>
			<th>Ruta</th>
			<th>Código de línea</th>
			<th>Destino</th>
			<th>Estado</th>
			<th>Parada actual</th>
			<th>Posición</th>
		</tr>
		</thead>
		<tbody>
		<tr>
			<td><a href="/routes/{{ nucleus.slug }}/{{ train.route_id }}">{{ train.route_id }}</a></td>
			<td>{{ train.route_short_name }}</td>
			<td>→ {{repo.get_stop_name(repo.route_destination(train.route_id)) or '—' }}</td>
			<td>{{ train.status_human() }}</td>
			
			<td>{{ repo.get_stop_name(train.stop_id) }} <i>({{ train.stop_id or "—" }})</i></td>
			<td>
				{% if train.lat and train.lon %}
					{{ '%.5f'|format(train.lat) }}, {{ '%.5f'|format(train.lon) }}
				{% else %}—{% endif %}
			</td>
		</tr>
		</tbody>
	</table>
{%- endblock %}
#}
