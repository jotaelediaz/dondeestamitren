{%- from "partials/helper_macros.html" import get_cercanias_line_icon, print_station_train_status_route_map with context %}
{%- set detail = train_detail_view %}
{%- set schedule = detail.schedule %}
{%- set status = detail.status %}
{%- set status_descriptor_map = {
    'scheduled': 'Programado',
    'unknown': 'Estado desconocido',
    'stationary': 'En estación:',
    'enroute': 'En tránsito a:',
    'arriving': 'Llegando a:'
} %}
{%- set status_descriptor_text = status_descriptor_map.get(status.status_descriptor, status_descriptor_map['unknown']) %}
{%- set train_type_label_map = {
    'scheduled': 'Programado',
    'destination': 'En destino',
    'origin': 'En origen',
    'in_transit': 'En circulación'
} %}
{%- if status.train_type_label == 'seen_age' %}
    {%- set train_type_label_text = 'Visto hace ' ~ (status.seen_age_seconds or 0) ~ ' s' %}
{%- else %}
    {%- set train_type_label_text = train_type_label_map.get(status.train_type_label, train_type_label_map['scheduled']) %}
{%- endif %}
{%- set is_live_train = status.is_live_train %}
{%- set origin_display_time = schedule.origin_time or schedule.scheduled_origin_time %}
{%- set origin_display_time = origin_display_time or '--:--' %}
{%- set is_live_at_origin = is_live_train and status.train_flow_state == 'origin' %}
{%- if not is_live_train %}
    {%- set origin_display_time = schedule.scheduled_origin_time or origin_display_time %}
{%- elif is_live_at_origin and schedule.origin_delay_minutes is not none and schedule.origin_delay_minutes < 0 %}
    {%- set origin_display_time = schedule.scheduled_origin_time or origin_display_time %}
{%- else %}
    {%- set origin_display_time = schedule.origin_time or schedule.scheduled_origin_time or origin_display_time %}
{%- endif %}

<div class="app-block-padding app-block-vertical-padding train-details-panel-wrapper">
    <div class="train-details-panel" data-train-id="{{ train_service.train_label }}" style="--line-color: {{ route.color_bg }}">
        <div class="train-details-header">
            <a href="/routes/{{ nucleus.slug }}/{{ train_service.route_id }}" class="train-details-route-link train-details-preheader">
                {{ get_cercanias_line_icon(train_service.route_short_name, nucleus.slug, route.color_bg) }}
                <span class="train-details-label">Línea {{ train_service.route_short_name }}</span>
            </a>
            <div class="train-type-badge {{ 'is-live' if status.is_live_train else 'is-scheduled' }} train-flow-state--{{ status.train_flow_state }}" title="{{ train_type_label_text }}" aria-label="Servicio {{ train_type_label_text }}">
                <span class="train-type-badge__label">{{ train_type_label_text }}</span>
                <span class="live-pill train-type-live-dot{% if status.live_badge_class %} {{ status.live_badge_class }}{% endif %}" aria-hidden="true">
                    <i class="dot"></i>
                </span>
            </div>
        </div>
        <div class="train-details-header-content">
            <div class="train-header-terminal origin">
                {{ train_service.origin_name or '—' }}
            </div>
            <div class="train-header-terminal through train-flow-state--{{ status.train_flow_state }}" aria-hidden="true">
                <span class="through-chevrons train-flow-state--{{ status.train_flow_state }}">
                    <span class="through-chevron"></span>
                    <span class="through-chevron"></span>
                    <span class="through-chevron"></span>
                </span>
            </div>
            <div class="train-header-terminal destination">
                {{ train_service.destination_name or '—' }}
            </div>
        </div>

        <div class="train-details-content">
            <div class="mini-route-map-grid">
                <div class="grid-route-map-station origin-station">
                    <div class="station-block origin-station">
                        <div class="grid-route-line">
                            <div class="route-line-time">
                                <span class="arrival-hour">{{ origin_display_time }}</span>
                            </div>
                            <div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
                                <i class="route-line-fragment" aria-hidden="true"></i>
                                <i class="route-dot" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-route-map-station through-station">
                    <div class="station-block origin-station">
                        <div class="grid-route-line">
                            <div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
                                <i class="route-line-fragment" aria-hidden="true"></i>
                                <i class="route-dot" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-route-map-station destination-station">
                    <div class="station-block destination-station">
                        <div class="grid-route-line">
                            <div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
                                <i class="route-line-fragment" aria-hidden="true"></i>
                                <i class="route-dot" aria-hidden="true"></i>
                            </div>
                            <div class="route-line-time">
                                <span class="arrival-hour">
                                    {{ schedule.destination_time or '--:--' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% set show_origin_label = schedule.show_origin_schedule_time %}
            {% set show_destination_label = schedule.show_destination_schedule_time %}
            {% set show_status_label = status.show_through_label %}
            {% set origin_label_visible = show_origin_label and (schedule.scheduled_origin_time or '') != (origin_display_time or '') %}
            {% if origin_label_visible or show_destination_label or show_status_label %}
                <div class="mini-route-map-labels" role="presentation">
                    <div class="mini-route-label origin-label">
                        {% if origin_label_visible %}
                            <div class="station-label">
                                <span class="arrival-hour-sched train-arrival-time--{{ schedule.origin_time_state }}">
                                    {{ schedule.scheduled_origin_time }}
                                    {% if schedule.origin_time_state == 'late' %}
                                        <span class="sr-only">Tren Demorado</span>
                                    {% elif schedule.origin_time_state == 'early' %}
                                        <span class="sr-only">Tren adelantado</span>
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="mini-route-label through-label">
                        {% if show_status_label %}
                            <span class="station-label station-status-label" title="{{ status_descriptor_text }}" aria-label="{{ status_descriptor_text }}">
                                <span class="station-status-icon" aria-hidden="true">
                                    <span class="material-symbols-rounded">{{ status.train_status_icon }}</span>
                                </span>
                                <span class="station-label-text">{{ status.station_name or status_descriptor_text }}</span>
                            </span>
                        {% endif %}
                    </div>
                    <div class="mini-route-label destination-label">
                        {% if show_destination_label %}
                            <div class="station-label">
                                <span class="arrival-hour-sched train-arrival-time--{{ schedule.destination_time_state }}">
                                    {{ schedule.scheduled_destination_time }}
                                    {% if schedule.destination_time_state == 'late' %}
                                        <span class="sr-only">Tren Demorado</span>
                                    {% elif schedule.destination_time_state == 'early' %}
                                        <span class="sr-only">Tren adelantado</span>
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="grouped-lists-scroll train-details-padding">
    <code>
        <ul>
            {% set next_stop_progress = train_service.next_stop_progress_pct if train_service.next_stop_progress_pct is not none else 0 %}
            {% set next_stop_progress_css = (next_stop_progress|string) ~ '%' %}
            <li data-train-progress>Porcentaje de avance: {{ next_stop_progress }}%</li>
            <li>Estado en directo: {{ train_service.status_text }}</li>
            <li>Parada actual: {{ train_service.current_stop_name or train_service.current_stop_id or '—' }}</li>
            <li>Siguiente parada: {{ train_service.next_stop_name or train_service.next_stop_id or '—' }}</li>
        </ul>
    </code>
    <div class="app-block-padding">
        {% set stop_views = detail.stops %}
        {% set live_platform_value = train_service.platform %}
        {% set live_platform_stop_id = train_service.next_stop_id %}
        {% if (train_service.current_status or '')|upper == 'STOPPED_AT' %}
            {% set live_platform_stop_id = train_service.current_stop_id or live_platform_stop_id %}
        {% endif %}
        {% set train_status_raw = (train_service.current_status or '')|upper %}
        {% if kind == 'scheduled' %}
            {% set train_status_key = 'SCHEDULED' %}
        {% elif train_status_raw in ['STOPPED_AT','IN_TRANSIT_TO','INCOMING_AT'] %}
            {% set train_status_key = train_status_raw %}
        {% else %}
            {% set train_status_key = 'UNKNOWN' %}
        {% endif %}
        {% set train_status_class = {
            'STOPPED_AT': 'train-status--stopped',
            'IN_TRANSIT_TO': 'train-status--enroute',
            'INCOMING_AT': 'train-status--arriving',
            'SCHEDULED': 'train-status--scheduled'
        }.get(train_status_key, 'train-status--unknown') %}
        {% set next_stop_progress = train_service.next_stop_progress_pct if train_service.next_stop_progress_pct is not none else 0 %}
        {% if next_stop_progress_css is not defined %}
            {% set next_stop_progress_css = (next_stop_progress|string) ~ '%' %}
        {% endif %}
        {% set train_current_stop_id = train_service.current_stop_id %}
        <ul class="grid-route-map train-status-route-map {{ 'scheduled-train' if kind == 'scheduled' else 'live-train' if kind == 'live'}} {{ train_status_class }}" data-train-status="{{ train_status_key|lower }}" data-number-of-stations="{{ detail.stop_count }}" data-train-progress-map style="--number-of-stations: {{ detail.stop_count }}; --line-color: {{ route.color_bg }}; --next_stop_progress: {{ next_stop_progress_css }}">
        {% for stop_view in stop_views %}
            {% set stop = stop_view.stop %}
            {% set platform_src = None %}
            {% set show_plat = None %}
            {% set live_plat = None %}
            {% set is_current_stop = (train_current_stop_id and (stop.stop_id|string) == (train_current_stop_id|string)) or ((stop_view.normalized_status or '')|upper == 'CURRENT') %}
            {% if live_platform_value and live_platform_stop_id and (stop.stop_id|string) == (live_platform_stop_id|string) %}
                {% set platform_src = 'live' %}
                {% set show_plat = live_platform_value %}
                {% set live_plat = live_platform_value %}
            {% endif %}
            <li id="stop-{{ stop.stop_id }}" class="grid-route-map-station {{ stop_view.status_class }} {{ stop_view.station_position }}{% if stop_view.is_next_stop %} next-stop{% endif %}{% if is_current_stop %} current-stop{% endif %}" data-station-id="{{ stop.station_id or stop.stop_id }}">
                {{ print_station_train_status_route_map(stop, stop_view.station_position, stop_view.scheduled_time, stop_view.rt_arrival_time, stop_view.normalized_status) }}
            </li>
        {% endfor %}
        </ul>
    </div>
</div>
