<div class="stop-detail">
	<div id="drawer-context"
	     data-nucleus="{{ nucleus.slug }}"
	     data-line-id="{{ route.line_id if route is defined else '' }}"
	     data-route-id="{{ route.route_id if route is defined else '' }}"
	     data-dir="{{ request.query_params.get('dir') or route.direction_id or '' }}"
	     data-stop-id="{{ stop.stop_id }}">
	</div>
	
	<header class="stop-modal-header">
		<h1 id="stop-modal-title">
			<a href="/stations/{{ nucleus.slug }}/{{ stop.stop_id }}">{{ stop.name }}</a>
		</h1>
		<button class="drawer-close close-button" type="button" aria-label="Cerrar">
			<i class="material-symbols-rounded" aria-hidden="true">close</i>
		</button>
	</header>
	
	<section class="stop-modal-body">
		{% if nearest_trains and nearest_trains|length > 0 %}
			<div id="approaching-trains">
				{% set nearest_pair = nearest_trains[0] %}
				{% set rec = nearest_pair[0] %}
				{% set nearest = rec.train %}
				{% set nearest_eta = nearest_pair[1] %}
				
				{% set sid_s = stop.stop_id|string %}
				{% set map = nearest.platform_by_stop|default({}) %}
				{% set plat = map.get(sid_s) or map.get(stop.stop_id) or nearest.platform %}
				{% set age = (nearest_last_seen or {}).get(nearest.train_id) %}
				{% set is_stale = (age or 0) > 900 %}
				{% set is_semi = not is_stale and (age or 0) > 30 %}
				
				<div class="nearest-train-card train-approaching" style="--train-color: {{ route.color_bg }}">
					{% if nearest_eta %}
						<div class="train-eta-chip">
							{% set origin_sid = route.stations[0].stop_id if route.stations else None %}
							{% set is_origin_stop = (origin_sid and stop.stop_id == origin_sid) %}
							
							{% set note = nearest_eta.note or '' %}
							{% set is_real = note.startswith('tu:') %}
							{% set is_sched = note.startswith('sched:') %}
							
							<div class="nearest-train-header eta-header" id="eta-label-{{ stop.stop_id }}">
{#                <span class="live-pill {{ 'is-stale' if is_stale else ('is-semi-stale' if is_semi else '') }}"
                      role="status"
                      aria-live="polite"
                      aria-label="{{ 'Se perdió la pista al tren hace más de 30 segundos' if (is_stale or is_semi) else 'En directo' }}"
                      title="{{ 'Se perdió la pista al tren hace más de 30 segundos' if (is_stale or is_semi) else 'En directo' }}">
                  <i class="dot" aria-hidden="true"></i>
                </span>#}
								{%- set live_label = 'En tiempo real' if (nearest_eta.note or '').startswith('tu:') else ('Tren programado' if (nearest_eta.note or '').startswith('sched:') else 'Tiempo aproximado') -%}
								<span class="live-pill {{ 'is-tu' if (nearest_eta.note or '').startswith('tu:') else ('is-sched' if (nearest_eta.note or '').startswith('sched:') else 'is-est') }}"
                      role="status"
                      aria-live="polite"
								      aria-label="{{ live_label }}"
                      title="{{ live_label }}">
                  <i class="dot" aria-hidden="true"></i>
                </span>
								{{ 'Salida del tren en:' if is_origin_stop else 'Próximo tren en:' }}
							</div>
						<div class="train-eta-output-wrapper">
							<output id="eta-primary"
							        class="train-eta-time"
							        role="status"
							        aria-live="polite"
							        aria-atomic="true"
							        aria-labelledby="eta-label-{{ stop.stop_id }}"
							        data-eta-min="{{ nearest_eta.minutes_rounded|int }}"
							        data-train-state="{{ nearest.current_status or '' }}">
								<time datetime="PT{{ nearest_eta.minutes_rounded|int }}M">
									{{ nearest_eta.minutes_rounded|int }}
								</time>
								<span class="unit">min</span>
							</output>
							
							<output id="eta-clock"
							        class="train-eta-time is-clock"
							        role="status"
							        aria-live="polite"
							        aria-atomic="true"
							        aria-labelledby="eta-label-{{ stop.stop_id }}"
							        data-eta-min="{{ nearest_eta.minutes_rounded|int }}"
							        data-train-state="{{ nearest.current_status or '' }}"
							        hidden aria-hidden="true" inert>
								<time datetime="">--:--</time>
								<span class="unit">h</span>
							</output>
						</div>
							
							{% set second_pair = nearest_trains[1] if nearest_trains|length > 1 else None %}
							<div class="second-train-approaching">
								{% if second_pair %}
									{% set rec2, r_eta = second_pair %}
									{% if r_eta %}
										<p class="second-train-label">
											<i class="material-symbols-rounded" aria-hidden="true">subdirectory_arrow_right</i>
											Siguiente en: <span class="second-train-eta"><strong>{{ r_eta.minutes_rounded }} min</strong></span>
										</p>
									{% endif %}
								{% endif %}
							</div>
						</div>
						
						{% if plat %}
							<div class="platform-chip">
								<div class="train-platform-badge" aria-labelledby="platform-label-{{ stop.stop_id }}">
									<div class="nearest-train-header platform-header" id="platform-label-{{ stop.stop_id }}">Vía</div>
									<div class="platform-badge" data-platform="{{ plat }}">
										<data value="{{ plat }}"><span class="platform-unit">{{ plat }}</span></data>
									</div>
								</div>
							</div>
						{% endif %}
					{% endif %}
				</div>
				
				<div class="stop-modal-footer" style="--train-color: {{ route.color_bg }}">
					<div class="train-id-chip">
						<div class="route-train-chip-icon chip-icon">
							<i class="material-symbols-rounded" aria-hidden="true">train</i>
						</div>
						<div class="train-id-badge">
							<a href="/trains/{{ nucleus.slug }}/{{ nearest.train_id }}"
							   aria-label="Ver detalle del tren {{ nearest.train_id }}">
							<data value="{{ nearest.train_id }}">Tren <span class="train-id-unit">{{ nearest.train_id }}</span></data>
							</a>
						</div>
					</div>
					<div class="view-train-link">
						<a href="/trains/{{ nucleus.slug }}/{{ nearest.train_id }}"
						   aria-label="Ver detalle del tren {{ nearest.train_id }}">
							<i class="material-symbols-rounded" aria-hidden="true">directions_railway</i>
							Ver tren
						</a>
					</div>
				</div>
			</div>
		{% else %}
			<div class="error-drawer no-stop-error">
				<i class="material-symbols-rounded" aria-hidden="true">hide_source</i>
				<span>No hay trenes aproximándose a la parada en este sentido ahora mismo.</span>
			</div>
		{% endif %}
	</section>
</div>
