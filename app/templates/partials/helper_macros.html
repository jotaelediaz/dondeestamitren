{%- macro get_cercanias_line_icon(line_code, nucleus_slug="", color = "#7a99b4") %}
	{% if nucleus_slug == "madrid" and (line_code.lower() in ("c1", "c2", "c3", "c3a", "c4", "c4a", "c4b", "c5", "c6", "c7", "c8", "c8a", "c8b", "c9", "c10")) %}
		{% set image_name = "icon-cercanias-madrid-" + line_code.lower() %}
		<div class="line-chip-icon image-line-icon">
			<img src="/static/img/lines-madrid/{{ image_name }}.svg" alt="{{ line_code }}">
		</div>
	{% elif nucleus_slug == "zaragoza" and (line_code.lower() in ("c1")) %}
		{% set image_name = "icon-cercanias-zaragoza-" + line_code.lower() %}
		<div class="line-chip-icon image-line-icon">
			<img src="/static/img/lines-zaragoza/{{ image_name }}.svg" alt="{{ line_code }}">
		</div>
	{% elif nucleus_slug == "malaga" and (line_code.lower() in ("c1, c2")) %}
		{% set image_name = "icon-cercanias-malaga-" + line_code.lower() %}
		<div class="line-chip-icon image-line-icon">
			<img src="/static/img/lines-malaga/{{ image_name }}.svg" alt="{{ line_code }}">
		</div>
	{%- else %}
		<div class="line-chip-icon chip-icon generic-chip-icon">
			<i class="material-symbols-rounded" aria-hidden="true">directions_subway</i>
		</div>
	{%- endif %}
{%- endmacro -%}


{%- macro print_station_route_map(stop, current_line_code = '') %}
	<div class="station-block" data-station-index="{{ stop.seq + 1 }}" data-stop-id="{{ stop.stop_id }}">
		<div class="grid-route-line">
			<div class="route-line-wrapper">
				<i class="route-line-fragment"></i>
				<i class="route-dot"></i>
			</div>
		</div>
		<div class="grid-route-station-info">
			<a href="/routes/{{ nucleus.slug }}/{{ route.route_id }}/stops/{{ stop.stop_id }}" class="stop-link">
				<div class="grid-route-station-name">
					<span class="station-name">{{ stop.stop_name }}</span>
				</div>
				<div class="grid-route-connections">
					<div class="connections-group">
						{% set connected_lines = repo.lines_for_stop(nucleus.slug, stop.stop_id, max_lines=8) | natural_sort %}
						{%- set station = repo.station_for_stop(nucleus.slug, stop.stop_id) -%}
	
						{% for ln in connected_lines %}
							{% set line_code = ln.short_name|lower %}
							{%- if line_code != current_line_code|lower and line_code not in ['c4a', 'c4b'] -%}
								{{ get_cercanias_line_icon(line_code, nucleus.slug) }}
							{%- endif -%}
						{% endfor %}
						
						{% if station.metro_lines %}<span class="station-badge metro-badge"><img alt="Metro" src="/static/img/icon-metro-madrid.svg"></span>{% endif %}
						{% if station.metro_ligero_lines %}<span class="station-badge metro-ligero-badge"><img alt="Metro Ligero" src="/static/img/icon-metro-ligero-madrid.svg"></span>{% endif %}
						{% if station.cor_tren_ld %}<span class="station-badge tren-badge"><img alt="Trenes de larga y media distancia" src="/static/img/icon-train-station-renfe.svg"></span>{% endif %}
						{% if station.cor_bus %}<span class="station-badge bus-badge"><img alt="Estación de autobuses" src="/static/img/icon-bus-renfe.svg"></span>{% endif %}
						{% if station.cor_aeropuerto %}<span class="station-badge aeropuerto-badge"><img alt="Aeropuerto" src="/static/img/icon-airport-renfe.svg"></span>{% endif %}
					</div>
				</div>
			</a>
		</div>
		<div class="grid-route-train-position">
			T
		</div>
	</div>
{%- endmacro -%}



{%- macro print_station_train_status_route_map(stop, station_position = 'mid-station', scheduled_time = None, rt_arrival_time = None, stop_status = None) -%}
	{%- set show_rt = (kind | default('scheduled') == 'live') and rt_arrival_time is not none -%}
	{%- set rt_hhmm = rt_arrival_time.hhmm if show_rt else None -%}
	{%- set delay_value = (rt_arrival_time.delay_min | default(0)) if show_rt else 0 -%}

<div class="station-block {{ station_position }}" role="group" data-station-index="{{ stop.seq + 1 }}" data-stop-id="{{ 'st-' ~ stop.stop_id }}" aria-labelledby="{{ _id }}-name" aria-describedby="{{ _id }}-times" {%- if is_current %} aria-current="location"{% endif %}>
	<div class="grid-route-line">
		<div class="route-line-wrapper" aria-hidden="true" role="presentation" tabindex="-1">
			<i class="route-line-fragment" aria-hidden="true"></i>
			<i class="route-dot" aria-hidden="true"></i>
		</div>
	</div>
	
	<div class="grid-route-station-info">
		<div class="grid-route-station-name">
      <span class="station-name" role="heading" aria-level="3">{{ stop.stop_name }}</span>
			{%- if stop_status == 'CURRENT' %}<span class="sr-only"> (Estación actual)</span>{%- endif %}
		</div>
		
		<div class="grid-route-connections">
			<dl class="stop-times">
				{%- if show_rt -%}
					<div class="stop-time real-time" aria-live="polite" aria-atomic="true">
						<dt class="sr-only">Hora en tiempo real</dt>
						<dd>
							<time class="stop-time-label" {%- if rt_hhmm %} datetime="{{ rt_hhmm }}"{% endif -%} {%- if rt_arrival_time.ts is defined %} data-epoch="{{ rt_arrival_time.ts }}"{% endif -%}>
								{{ rt_hhmm }}
							</time>
						</dd>
					</div>
				{%- endif -%}
						
					{%- if scheduled_time is not none and (not show_rt or rt_hhmm != scheduled_time) -%}
						<div class="stop-time scheduled-time{% if show_rt and rt_hhmm != scheduled_time %} scheduled-time-is-not-current{% endif %}">
							<dt class="sr-only">Hora programada</dt>
							<dd><time class="stop-time-label" datetime="{{ scheduled_time }}">{{ scheduled_time }}</time>
							</dd>
						</div>
					{%- endif -%}
					
					{%- if show_rt and delay_value != 0 -%}
						<dd>
							<data class="stop-time-label delay-label{% if delay_value>0 %} delayed-train{% elif delay_value<0 %} advanced-train{% endif %}" value="{{ delay_value }}" aria-label="{% if delay_value>0 %}+{{ delay_value }} minutos de retraso{% else %}{{ delay_value|abs }} minutos de adelanto{% endif %}">
								({% if delay_value>0 %}+{{ delay_value }} min{% else %}-{{ delay_value|abs }} min{% endif %})
							</data>
						</dd>
				{%- endif -%}
			</dl>
		</div>
	</div>
	
	<div class="grid-route-train-position">
		<span aria-hidden="true">T</span>
	</div>
</div>
{%- endmacro -%}
