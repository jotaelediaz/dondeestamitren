{% set payload = map_payload or {} %}
{% set payload_pos = payload.position if payload else None %}
{% set position = map_position if map_position is not none else payload_pos %}
{% set train_obj = payload.train if payload else {} %}
{% set map_lat = position.lat if position else None %}
{% set map_lon = position.lon if position else None %}
{% set map_heading = position.heading if position else None %}
{% set map_label = map_train_label or train_obj.id or train_obj.train_id or train_obj.label %}
{% set map_route_id_final = map_route_id or train_obj.route_id %}
{% set map_dir_final = map_direction_id or train_obj.direction_id %}

<div class="train-map-container">
    <div id="{{ map_element_id | default('train-detail-map') }}"
         data-train-map="true"
         role="region"
         aria-label="Mapa con la posiciÃ³n actual del tren {{ map_label }}"
         {% if map_lat is not none %}data-map-lat="{{ map_lat }}"{% endif %}
         {% if map_lon is not none %}data-map-lon="{{ map_lon }}"{% endif %}
         {% if map_heading is not none %}data-map-heading="{{ map_heading }}"{% endif %}
         data-map-train="{{ map_label }}"
         data-map-route-id="{{ map_route_id_final or '' }}"
         data-map-route-dir="{{ map_dir_final or '' }}"
         data-map-api="{{ map_api or '' }}"
         data-map-line-color="{{ map_line_color or '' }}"
         data-map-route="{{ map_route_name or '' }}"
         {% if map_route_geojson %}data-map-route-geojson='{{ map_route_geojson | tojson }}'{% endif %}
         {% if map_route_stops_geojson %}data-map-stops-geojson='{{ map_route_stops_geojson | tojson }}'{% endif %}>
    </div>
</div>
