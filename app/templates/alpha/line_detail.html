<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<title>Línea {{ line.short_name }} ({{ line.line_id }}) · {{ repo.nucleus_name(line.nucleus_id) or nucleus.name }}</title>
</head>
<body>
<p>
	<a href="/alpha/lines/{{ nucleus.slug }}">&larr; Volver al listado</a>
</p>

<h1>
	<span style="background: {{ line.color_bg }}; color: {{ line.color_fg }}; width: 1em; height: 1em; border-radius: 100%; vertical-align: -0.15em; display: inline-block;"> </span>
	Línea {{ line.short_name }} ({{ line.line_id }}) · {{ repo.nucleus_name(line.nucleus_id) or nucleus.name }}
</h1>

{% if not line.variants %}
	<p>Esta línea no tiene variantes detectadas.</p>
{% else %}
	<h2>Variantes</h2>
	<table border="1" cellpadding="6" cellspacing="0">
		<thead>
		<tr>
			<th>Canónica</th>
			<th>Terminales (A ↔ B)</th>
			<th>Dirección</th>
			<th>Paridad Nº Tren</th>
			<th>Rutas (route_id)</th>
			<th>Acciones</th>
		</tr>
		</thead>
		<tbody>
		{% for var in line.variants %}
			{% set a = var.terminals_sorted[0] %}
			{% set b = var.terminals_sorted[1] %}
			{% set canon_mark = "✔" if var.is_canonical else "—" %}
			{% set dir_keys = var.directions.keys()|list|sort %}
			{% if dir_keys|length == 0 %}
				<tr>
					<td style="text-align:center">{{ canon_mark }}</td>
					<td>
						{% if a %}<a href="/alpha/stations/{{ nucleus.slug or line.nucleus_id }}/{{ a }}">{{ repo.get_stop_name_or_id(a) }}</a>{% else %}—{% endif %}
						&nbsp;↔&nbsp;
						{% if b %}<a href="/alpha/stations/{{ nucleus.slug or line.nucleus_id }}/{{ b }}">{{ repo.get_stop_name_or_id(b) }}</a>{% else %}—{% endif %}
					</td>
					<td>—</td>
					<td>—</td>
					<td>
						{% for rid in var.route_ids %}
							<div><a href="/alpha/routes/{{ nucleus.slug or line.nucleus_id }}/{{ rid }}">{{ rid }}</a></div>
						{% endfor %}
					</td>
					<td>—</td>
				</tr>
			{% else %}
				{% for did in dir_keys %}
					{% set d = var.directions[did] %}
					<tr>
						{% if loop.first %}
							<td style="text-align:center" rowspan="{{ dir_keys|length }}">{{ canon_mark }}</td>
							<td rowspan="{{ dir_keys|length }}">
								{% if a %}<a href="/alpha/stations/{{ nucleus.slug or line.nucleus_id }}/{{ a }}">{{ repo.get_stop_name_or_id(a) }}</a>{% else %}—{% endif %}
								&nbsp;↔&nbsp;
								{% if b %}<a href="/alpha/stations/{{ nucleus.slug or line.nucleus_id }}/{{ b }}">{{ repo.get_stop_name_or_id(b) }}</a>{% else %}—{% endif %}
							</td>
						{% endif %}
						
						<td><strong>{{ did }}</strong></td>
						
						{% set rid0 = d.route_ids[0] if d.route_ids and d.route_ids|length else None %}
						{% set even_did = repo.dir_for_parity(rid0, 'even') if rid0 else None %}
						{% set odd_did  = repo.dir_for_parity(rid0, 'odd')  if rid0 else None %}
						{% set parity_text = 'Pares' if did == even_did else 'Impares' if did == odd_did else '?' %}
						<td>{{ parity_text }}</td>
						
						<td>
							{% if d.route_ids %}
								<div>
									{% for rid in d.route_ids %}
										<div><a href="/alpha/routes/{{ nucleus.slug or line.nucleus_id }}/{{ rid }}">{{ rid }}</a></div>
									{% endfor %}
								</div>
							{% else %}
								—
							{% endif %}
						</td>
						<td>
							{% if d.route_ids and d.route_ids|length %}
								<a href="/alpha/routes/{{ nucleus.slug or line.nucleus_id }}/{{ d.route_ids[0] }}/stops">Ver paradas</a>
							{% else %}
								—
							{% endif %}
						</td>
					</tr>
				{% endfor %}
			{% endif %}
		{% endfor %}
		</tbody>
	</table>
{% endif %}

<section id="live-trains-section" class="mt-4">
	<h2>Trenes en directo en esta línea</h2>
	
	{% if not trains %}
		<div class="empty-state">No hay trenes en directo para esta línea ahora mismo.</div>
	{% else %}
		<table border="1" cellpadding="6" cellspacing="0">
			<thead>
			<tr>
				<th>Tren</th>
				<th>Ruta</th>
				<th>Destino</th>
				<th>Estado</th>
				<th>Parada actual</th>
				<th>Posición</th>
			</tr>
			</thead>
			<tbody>
			{% for t in trains %}
				<tr>
					<td><a href="/alpha/trains/{{ nucleus.slug }}/{{ t.train_id }}">{{ t.train_id }}</a></td>
					<td>{{ t.route_id }}</td>
					<td>→ {{repo.get_stop_name(repo.route_destination(t.route_id)) or '—' }}</td>
					<td>{{ t.status_human() }}</td>
			
					
					<td>{{ repo.get_stop_name(t.stop_id) }} <i>({{ t.stop_id or "—" }})</i></td>
					<td>
						{% if t.lat and t.lon %}
							{{ '%.5f'|format(t.lat) }}, {{ '%.5f'|format(t.lon) }}
						{% else %}—{% endif %}
					</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	{% endif %}
</section>

</body>
</html>
