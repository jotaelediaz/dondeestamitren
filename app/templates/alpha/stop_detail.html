<header>
	<a href="/alpha/routes/{{ nucleus.slug }}/{{ route.route_id }}">
		&larr; Volver a línea
	</a>
	
	<h1>Parada de ruta: {{ stop.name }}</h1>
	<ul>
		<li><strong>Ruta:</strong> {{ route.route_long_name }} <i>({{ route.route_id }})</i></li>
		<li><strong>Nombre corto de ruta:</strong> {{ route.route_short_name }}</li>
		<li><strong>Secuencia de parada en la línea:</strong> {{ stop.seq + 1}} <i>(seq: {{ stop.seq }})</i> </li>
		<li><strong>Núcleo:</strong> {{ nucleus.name }}</li>
		<li><strong>Punto kilométrico:</strong> {{ '%.1f'|format(stop.km) }} km</li>
		<li><strong>Destino de la ruta:</strong>→ {{repo.get_stop_name(repo.route_destination(route.route_id)) or '—' }}</li>
		<li class="coords"><strong>Coordenadas:</strong> {{ '%.5f'|format(stop.lat) }}, {{ '%.5f'|format(stop.lon) }}</li>
	</ul>
	<p>➜ <a href="/alpha/stations/{{ nucleus.slug }}/{{ stop.station_id | urlencode }}">Ver ficha de estación</a></p>
</header>

<section>
	<h2>Trenes más cercanos a la parada</h2>
	
	{% if nearest_trains and nearest_trains|length > 0 %}
		<table border="1" cellpadding="6" cellspacing="0">
			<thead>
			<tr>
				<th>Tren</th>
				<th>Ruta</th>
				<th>Lat</th>
				<th>Lon</th>
				<th>Tiempos</th>
				<th>¿Estación pasada?</th>
			</tr>
			</thead>
			<tbody>
			{% for item in nearest_trains %}
				{% set r   = (item[0] if (item is sequence and item|length >= 1) else item) %}
				{% set eta = (item[1] if (item is sequence and item|length >= 2) else None) %}
				
				{% set route_obj = (repo.get_by_route_and_dir(r.route_id, r.direction_id) if repo is defined else None) %}
				{% set route_label = route_obj.route_short_name if route_obj is not none else r.route_id %}
				
				{% set lat = r.train.lat or 0 %}
				{% set lon = r.train.lon or 0 %}
				{% set ts  = r.train.ts or '-' %}
				{% set pasada = (not r.approaching) %}
				
				<tr>
					<td>
						<a href="/alpha/trains/{{ nucleus.slug }}/{{ r.train.train_id }}">{{ r.train.train_id }}</a>
					</td>
					<td>{{ route_label }}</td>
					<td>{{ '%.5f'|format(lat|float) }}</td>
					<td>{{ '%.5f'|format(lon|float) }}</td>
					<td>
						{% if eta %}
							~{{ eta.minutes_rounded }} min
							<small class="muted">({{ '%.1f'|format(eta.distance_km) }} km)</small>
						{% else %}
							—
						{% endif %}
					</td>
					<td>
						{% if pasada %}
							Sí <small class="muted">({{ '%.1f'|format(r.abs_delta_km|float) }} km atrás)</small>
						{% else %}
							No
						{% endif %}
					</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	{% else %}
		<p>No hay trenes cercanos ahora mismo.</p>
	{% endif %}
</section>