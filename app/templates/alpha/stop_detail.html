<header>
	<a href="/alpha/routes/{{ nucleus.slug }}/{{ route.route_id }}">
		&larr; Volver a línea
	</a>
	
	<h1>Parada de ruta: {{ stop.name }}</h1>
	<ul>
		<li><strong>Ruta:</strong> {{ route.route_long_name }} <i>({{ route.route_id }})</i></li>
		<li><strong>Nombre corto de ruta:</strong> {{ route.route_short_name }}</li>
		<li><strong>Secuencia de parada en la línea:</strong> {{ stop.seq + 1}} <i>(seq: {{ stop.seq }})</i> </li>
		<li><strong>Núcleo:</strong> {{ nucleus.name }}</li>
		<li><strong>Punto kilométrico:</strong> {{ '%.1f'|format(stop.km) }} km</li>
		<li><strong>Destino de la ruta:</strong>→ {{repo.get_stop_name(repo.route_destination(route.route_id)) or '—' }}</li>
		<li class="coords"><strong>Coordenadas:</strong> {{ '%.5f'|format(stop.lat) }}, {{ '%.5f'|format(stop.lon) }}</li>
	<li><strong>Vía habitual:</strong>
		{% if habitual_platform %}
			{{ habitual_platform }}
			{% if habitual_publishable is defined and not habitual_publishable %}
				<i>(no publicable)</i>
			{% endif %}
		{% else %}
			???
		{% endif %}
	</li>
	</ul>
	
	<p>➜ <a href="/alpha/stations/{{ nucleus.slug }}/{{ stop.station_id | urlencode }}">Ver ficha de estación</a></p>
</header>

<section>
	<h2>Trenes más cercanos a la parada</h2>
	{% set cards = nearest_services if nearest_services is defined else (nearest_service and [nearest_service]) %}
	{% if cards %}
		<table border="1" cellpadding="6" cellspacing="0">
			<thead>
			<tr>
				<th>#</th>
				<th>Tren</th>
				<th>Estado</th>
				<th>ETA</th>
				<th>Hora</th>
				<th>Vía</th>
				<th>Fuente</th>
			</tr>
			</thead>
			<tbody>
			{% for card in cards[:10] %}
				{% set prediction = card.get('prediction') %}
				{% set row = card.get('row') or {} %}
				{% set train = card.get('train') %}
				{% set minutes = card.get('minutes_rounded') %}
				{% set hhmm = prediction.hhmm if prediction else None %}
				{% if not hhmm %}
					{% set hhmm = row.get('eta_arr_hhmm') or row.get('eta_dep_hhmm') or row.get('sched_arr_hhmm') or row.get('sched_dep_hhmm') %}
				{% endif %}
				{% set epoch = prediction.epoch if prediction else None %}
				{% if epoch is none %}
					{% set epoch = row.get('eta_arr_epoch') or row.get('eta_dep_epoch') or row.get('sched_arr_epoch') or row.get('sched_dep_epoch') %}
				{% endif %}
				{% set status = (prediction.status if prediction else 'scheduled')|lower %}
				{% set status_label = 'Tiempo real' if status == 'realtime' else 'Programado' %}
				{% set platform_info = card.get('platform_info') or {} %}
				{% set observed_platform = platform_info.get('observed') %}
				{% set predicted_platform = platform_info.get('predicted_alt') or platform_info.get('predicted') %}
				{% set row_platform = row.get('platform') %}
				{% set habitual_plat = habitual_platform if habitual_platform else None %}
				{% set display_platform = observed_platform or row_platform or predicted_platform or habitual_plat or '?' %}
				{% set source = prediction.source if prediction else row.get('eta_source') %}
				{% set train_id = prediction.train_id if prediction else None %}
				{% if not train_id and train %}
					{% set train_id = train.train_id %}
				{% endif %}
				<tr>
					<td>{{ loop.index }}</td>
					<td>
						{% if train_id %}
							<a href="/alpha/trains/{{ nucleus.slug }}/{{ train_id }}">{{ train_id }}</a>
						{% else %}
							—
						{% endif %}
					</td>
					<td>{{ status_label }}</td>
					<td>
						{% if minutes is not none %}
							{{ minutes }} min
						{% else %}
							—
						{% endif %}
					</td>
					<td>{{ hhmm or '—' }}</td>
					<td>{{ display_platform }}</td>
					<td>{{ source or '—' }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	{% else %}
		<p>No hay trenes cercanos ahora mismo.</p>
	{% endif %}
</section>
