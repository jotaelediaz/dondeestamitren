<header>
	{% if nucleus %}
		<a href="/alpha/trains/{{ nucleus.slug }}">&larr; Volver a {{ nucleus.name }}</a>
	{% else %}
		<a href="/alpha/trains/">&larr; Volver a trenes</a>
	{% endif %}

	<h1>
		Tren {{ unified.train_label }}{% if unified.kind == 'scheduled' %} (programado){% endif %}
	</h1>
	
	{% if confidence %}
		<span title="{{ confidence.tooltip }}">
      <span>{{ confidence.icon }}</span>
      <span>Confianza en la clasificaciÃ³n en rutas del tren: {{ confidence.label }}</span>
      <small>({{ confidence.source }})</small>
    </span>
	{% endif %}
	
	<p>Ãšltima actualizaciÃ³n de la API: {{ last_snapshot }} ({{ last_source or 'â€”' }})</p>
	
	{% if kind == 'live' and train %}
		<p>
			Tren visto por Ãºltima vez: {{ train_seen_iso }} â€” hace {{ train_seen_age }} s
			{{ 'ðŸ”´' if train_seen_age > 900 else 'ðŸŸ¡' if train_seen_age > 30 else 'ðŸŸ¢'}}
		</p>
	{% endif %}
	<p>
		<a href="/alpha/trains/{{ nucleus.slug }}/{{ unified.train_label }}/map">â†’ Ver tren en un mapa</a>
	</p>
</header>

<table border="1" cellpadding="6" cellspacing="0">
	<thead>
	<tr>
		<th>Ruta</th>
		<th>CÃ³digo de lÃ­nea</th>
		<th>Destino</th>
		<th>Estado</th>
		<th>Parada actual</th>
		<th>VÃ­a</th>
		<th>PosiciÃ³n</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<td>
			{% if unified.route_id %}
				<a href="/alpha/routes/{{ nucleus.slug }}/{{ unified.route_id }}">{{ unified.route_id }}</a>
			{% else %}â€”{% endif %}
		</td>
		<td>{{ unified.route_short_name or 'â€”' }}</td>
		<td>{{ unified.destination_name or 'â€”' }}</td>
		<td>{{ unified.status_text or 'â€”' }}</td>
		<td>
			{% if kind == 'live' and train %}
				{{ repo.get_stop_name(train.stop_id) }} <i>({{ train.stop_id or "â€”" }})</i>
			{% else %}â€”{% endif %}
		</td>
		<td>{{ unified.platform or 'â€”' }}</td>
		<td>
			{% if unified.lat is not none and unified.lon is not none %}
				{{ '%.5f'|format(unified.lat) }}, {{ '%.5f'|format(unified.lon) }}
			{% else %}â€”{% endif %}
		</td>
	</tr>
	</tbody>
</table>

<hr/>

{% set rows = stop_rows or (trip.stops if trip and trip.stops else unified.stops) %}
{% if rows %}
	<h2>Paradas del servicio</h2>
	<table border="1" cellpadding="6" cellspacing="0">
		<thead>
		<tr>
			<th>#</th>
			<th>Parada</th>
			<th>Programado</th>
			<th>Llegada real (TU/RT)</th>
			<th>Salida real</th>
			<th>Retraso</th>
			<th>RelaciÃ³n</th>
			<th>Estado</th>
		</tr>
		</thead>
		<tbody>
		{% for r in rows %}
			{% set seq = r.get('seq') %}
			{% set stop_id = r.get('stop_id') %}
			{% set stop_name = r.get('stop_name') or repo.get_stop_name(stop_id) or stop_id %}
			{% set passed_hhmm = r.get('passed_at_hhmm') %}
			{% set passed_epoch = r.get('passed_at_epoch') %}
			{% set passed_delay_min = r.get('passed_delay_min') %}

			{% set scheduled_hhmm =
				r.get('scheduled_hhmm') or r.get('sched_arr_hhmm') or r.get('sched_dep_hhmm') %}
			{% set scheduled_epoch =
				r.get('scheduled_epoch') or r.get('sched_arr_epoch') or r.get('sched_dep_epoch') %}
			{% set departed_hhmm = r.get('departed_at_hhmm') %}
			{% set departed_epoch = r.get('departed_at_epoch') %}
			{% set departed_delay_min = r.get('departed_delay_min') %}

			{% set real_hhmm =
				passed_hhmm
				or r.get('tu_hhmm')
				or r.get('rt_hhmm')
				or r.get('eta_arr_hhmm')
				or r.get('eta_dep_hhmm') %}
			{% set real_epoch =
				passed_epoch
				or r.get('tu_dep_epoch')
				or r.get('tu_arr_epoch')
				or r.get('rt_epoch')
				or r.get('eta_arr_epoch')
				or r.get('eta_dep_epoch') %}
			
			{% set tu_delay_s = r.get('tu_delay_s') %}
			{% if passed_delay_min is not none %}
				{% set delay_min = passed_delay_min %}
			{% elif tu_delay_s is not none %}
				{% set delay_min = (tu_delay_s // 60) %}
			{% elif (real_epoch is not none) and (scheduled_epoch is not none) %}
				{% set delay_min = ((real_epoch - scheduled_epoch) // 60) %}
			{% else %}
				{% set delay_min = r.get('delay_min') %}
			{% endif %}
			
			{% set status_raw = (r.get('status') or r.get('flag') or 'upcoming')|lower %}
			{% set flag =
				'current' if status_raw == 'current' else
				'next'    if status_raw == 'next' else
				'passed'  if status_raw == 'passed' else
				'upcoming' %}
			
			<tr
				{% if flag == 'current' %} style="background:#e6ffe6"{% endif %}
				{% if flag == 'next' %} style="background:#fff9e6"{% endif %}
				{% if flag == 'passed' %} style="color:#777"{% endif %}
			>
				<td>{{ seq }}</td>
				
				<td>
					<a href="/alpha/routes/{{ nucleus.slug }}/{{ unified.route_id }}/stops/{{ stop_id }}">{{ stop_name or 'â€”' }}</a>
					<small><i>({{ stop_id or 'â€”' }})</i></small>
				</td>
				
				<td>
					{% if scheduled_hhmm %}
						{{ scheduled_hhmm }}
						{% if scheduled_epoch is not none %}<small>({{ scheduled_epoch }})</small>{% endif %}
					{% else %}
						â€”
					{% endif %}
				</td>
				
				<td>
					{% if real_hhmm %}
						<b>{{ real_hhmm }}</b>
						{% if real_epoch is not none %}<small>({{ real_epoch }})</small>{% endif %}
						{% elif r.get('live_hhmm') %}
						{{ r.get('live_hhmm') }}
					{% else %}
						â€”
					{% endif %}
				</td>
				
				<td>
					{% if departed_hhmm %}
						<b>{{ departed_hhmm }}</b>
						{% if departed_epoch is not none %}<small>({{ departed_epoch }})</small>{% endif %}
					{% else %}
						â€”
					{% endif %}
				</td>
				
				<td>
					{% if delay_min is not none %}
						{{ '+' if delay_min > 0 else '' }}{{ delay_min }} min
					{% else %}â€”{% endif %}
				</td>
				
				<td>{{ r.get('tu_rel') or r.get('rel') or 'â€”' }}</td>
				
				<td>
					{% if flag == 'current' %}Ahora
						{% elif flag == 'next' %}Siguiente
						{% elif flag == 'passed' %}Pasada
					{% else %}PrÃ³xima{% endif %}
				</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
{% endif %}

<hr>

<h2>Servicio / Trip asociado</h2>
<table border="1" cellpadding="6" cellspacing="0">
	<thead>
	<tr>
		<th>Trip ID</th>
		<th>Salida programada</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<td>{{ unified.trip_id or 'â€”' }}</td>
		<td>
			{% if unified.scheduled_departure_hhmm %}
				{{ unified.scheduled_departure_hhmm }}
				{% if unified.scheduled_departure_epoch %} ({{ unified.scheduled_departure_epoch }}){% endif %}
			{% else %}
				â€”
			{% endif %}
		</td>
	</tr>
	</tbody>
</table>

{% if unified.rt_prediction %}
	<hr>
	
	<h2>PredicciÃ³n (Trip Update)</h2>
	<table border="1" cellpadding="6" cellspacing="0">
		<thead>
		<tr>
			<th>PrÃ³xima parada</th>
			<th>Hora prevista</th>
			<th>Retraso</th>
			<th>Estado TU</th>
			<th>Progreso</th>
			<th>next_stop_progress_pct</th>
			<th>Actualizado</th>
		</tr>
		</thead>
		<tbody>
		<tr>
			<td>{{ unified.rt_prediction.next_stop_name or unified.rt_prediction.next_stop_id or 'â€”' }}</td>
			<td>
				{% set eta = unified.rt_prediction.next_departure_epoch or unified.rt_prediction.next_arrival_epoch %}
				{% set eta_hhmm = eta | hhmm_local %}
				{% set eta_display = unified.rt_prediction.next_departure_hhmm
					or unified.rt_prediction.next_arrival_hhmm
					or eta_hhmm %}
				{% if eta_display %}
					{{ eta_display }}
					{% if eta %}<span class="muted">({{ eta }})</span>{% endif %}
				{% else %}â€”{% endif %}
			</td>
			<td>
				{% if unified.rt_prediction.next_delay_s is not none %}
					{% set dmin = (unified.rt_prediction.next_delay_s // 60) %}
					{{ '+' if dmin > 0 else '' }}{{ dmin }} min
				{% else %}â€”{% endif %}
			</td>
			<td>{{ unified.rt_prediction.schedule_relationship or 'â€”' }}</td>
			<td>
				{% if unified.rt_prediction.progress and unified.rt_prediction.progress.next_stop_index is not none and unified.rt_prediction.progress.total_stops is not none %}
					{{ unified.rt_prediction.progress.next_stop_index }}/{{ unified.rt_prediction.progress.total_stops }}
				{% else %}â€”{% endif %}
			</td>
			<td>
				{% if unified.rt_prediction.next_stop_progress_pct is not none %}
					{{ unified.rt_prediction.next_stop_progress_pct }}%
				{% else %}â€”{% endif %}
			</td>
			<td>
				{% if unified.rt_prediction.tu_timestamp_iso %}
					{{ unified.rt_prediction.tu_timestamp_iso }}
				{% else %}
					{{ unified.rt_prediction.tu_timestamp or 'â€”' }}
				{% endif %}
			</td>
		</tr>
		</tbody>
	</table>
{% endif %}
